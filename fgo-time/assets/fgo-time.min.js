let naServerDST=spacetime.now("Pacific Time").isDST(),etInterval=new interval(etTimersUpdate,"1s"),ftClockInterval=new interval(ftClockUpdate,"1s"),settings=localStorage.getItem("fgo-time-settings"),jpToLocal=0,naToLocal=0;$(init),$(window).on("unload",()=>localStorage.setItem("fgo-time-settings",JSON.stringify(settings)));function init(){settings=null==settings?{showNa:!0,showJp:!0,showEventTimers:!0,showTimeTable:!0,showApCalc:!0,showLinks:!0}:JSON.parse(settings),!1===settings.showEventTimers&&($("#events").addClass("section-hidden"),$("#events > .content").hide()),!1===settings.showTimeTable&&($("#time-table").addClass("section-hidden"),$("#time-table > .content").hide()),!1===settings.showApCalc&&($("#ap-calc").addClass("section-hidden"),$("#ap-calc > .content").hide()),!1===settings.showLinks&&($("#links").addClass("section-hidden"),$("#links > .content").hide()),!1===settings.showNa&&$("#show-na").prop("checked",!1),!1===settings.showJp&&$("#show-jp").prop("checked",!1),settings.maxAp&&$("#ap-calc-max-ap").val(settings.maxAp),settings.targetAp&&$("#ap-calc-target-ap").val(settings.targetAp),settings.currAp&&$("#ap-calc-current-ap").val(settings.currAp),etTableSetup()&&!1!==settings.showEventTimers&&(etTimersUpdate(),etInterval.start()),ftTimeTableSetup(),ftClockUpdate(),ftApCalcUpdate(),ftClockInterval.start(),$("main section > h1").on("click",sectionToggleDisplay),$("#ap-calc input").on("input",ftApCalcUpdate),$("main").show(),$("#loading").hide()}function sectionToggleDisplay(){for(section=$(this).parent();section&&!section.is("section");)section=section.parent();section.hasClass("section-hidden")?(section.removeClass("section-hidden"),section.find(".content").slideDown(200),settings["show"+section.data("name")]=!0,"events"==section.attr("id")&&(etTimersUpdate(),etInterval.start())):(section.addClass("section-hidden"),section.find(".content").slideUp(200),settings["show"+section.data("name")]=!1,"events"==section.attr("id")&&etInterval.stop())}function etTableSetup(){if(null!==eventTimer.NA.banner){let a=$("<img>").attr("src","assets/img/"+eventTimer.NA.banner);$("#event-banner-na").append(a)}if(null!==eventTimer.JP.banner){let a=$("<img>").attr("src","assets/img/"+eventTimer.JP.banner);$("#event-banner-jp").append(a)}if(1>eventTimer.NA.timer.length&&1>eventTimer.JP.timer.length)return!1;let a=Math.max(eventTimer.NA.timer.length,eventTimer.JP.timer.length);for(let b=0;b<a;b++){let a=$("<tr>"),c=$("<td>"),d=$("<td>");eventTimer.NA.timer[b]&&(c.append($("<span>").html(eventTimer.NA.timer[b].text+": ")),c.append($("<span>").addClass("timer").addClass("timer-na"))),eventTimer.JP.timer[b]&&(d.append($("<span>").html(eventTimer.JP.timer[b].text+": ")),d.append($("<span>").addClass("timer").addClass("timer-jp"))),a.append(c).append(d),$("#events table tbody").append(a)}return!0}function etTimersUpdate(){for(let a in eventTimer.NA.timer)$("#events table tbody").children().eq(a).find(".timer-na").html(etCalcTimer(eventTimer.NA.timer[a].time));for(let a in eventTimer.JP.timer)$("#events table tbody").children().eq(a).find(".timer-jp").html(etCalcTimer(eventTimer.JP.timer[a].time))}function etCalcTimer(a){let b=a-(0|Date.now()/1e3);if(0>=b)return"00:00:00:00";else{let a=b,c=0|a/86400;a%=86400;let d=0|a/3600;a%=3600;let e=0|a/60;a%=60;let f=(10>c?"0":"")+(c+"")+":"+(10>d?"0":"")+(d+"")+":"+(10>e?"0":"")+(e+"")+":"+(10>a?"0":"")+(a+"");return f}}function ftTimeTableSetup(){$("input[type='checkbox']").on("change",ftTimeTableToggleDisplay);let a=[];for(let b in a=naServerDST?a.concat(ftTimeTableEvents.NA_DST):a.concat(ftTimeTableEvents.NA),a=a.concat(ftTimeTableEvents.JP),a){let c,d,e;c="na"==a[b].server?60*a[b].time-naToLocal:60*a[b].time-jpToLocal,0>c&&(c+=1440),1439<c&&(c-=1440),d=0|c/60,e=(c-60*d+"").padStart(2,"0"),d=(d+"").padStart(2,"0"),a[b].localTime=d+":"+e,a[b].sortTime=+(d+e)}a.sort(function(c,a){return c.sortTime-a.sortTime});for(let b of a){let a=$("<tr/>").attr("data-server",b.server),c=b.localTime,d=(b.time+"").padStart(2,"0");a.append($("<td/>").html(c)),a.append($("<td/>").html(d.concat(":00 ","na"==b.server?naServerDST?"PDT":"PST":"JST"))),a.append($("<td/>").html(b.server.toUpperCase())),a.append($("<td/>").html(b.desc)),$("#time-table table tbody").append(a)}ftTimeTableUpdateFilter()}function ftTimeTableToggleDisplay(){switch(this.id){case"show-na":settings.showNa=this.checked;break;case"show-jp":settings.showJp=this.checked;break;default:return!1;}ftTimeTableUpdateFilter()}function ftTimeTableUpdateFilter(){let a=$("#time-table table tbody").children();for(let b of a){let a=$(b).data("server");if("na"===a){settings.showNa?$(b).show():$(b).hide();continue}"jp"===a&&(settings.showJp?$(b).show():$(b).hide())}}function ftClockUpdate(){let a=spacetime.now(),b=new Date().getTimezoneOffset(),c=a.format("{hour-pad}:{minute-pad}{ampm}").toUpperCase(),d=a.clone().add(b,"minutes"),e=d.format("{hour-pad}:{minute-pad}{ampm}").toUpperCase(),f=spacetime.now("Pacific Time").timezone().current.offset,g=d.clone().add(f,"hours"),h=g.format("{hour-pad}:{minute-pad}{ampm}").toUpperCase(),i=spacetime.now("Asia/Tokyo").timezone().current.offset,j=d.clone().add(i,"hours"),k=j.format("{hour-pad}:{minute-pad}{ampm}").toUpperCase();jpToLocal=60*i+b,naToLocal=60*f+b,$("#clock-local > h2").html(c),$("#clock-utc > h2").html(e),$("#clock-na > h2").html(h),$("#clock-jp > h2").html(k)}function ftApCalcUpdate(){let a=+$("#ap-calc-max-ap").val(),b=+$("#ap-calc-target-ap").val(),c=+$("#ap-calc-current-ap").val();142<a&&(a=142,$("#ap-calc-max-ap").val(142)),0==a&&(a=1,$("#ap-calc-max-ap").val(1)),b>a&&(b=a,$("#ap-calc-target-ap").val(b)),$("#ap-calc-target-ap").attr("max",a),c>=b&&(c=b-1,$("#ap-calc-current-ap").val(c)),$("#ap-calc-current-ap").attr("max",b-1),apToTarget=b-c,minsToTarget=5*apToTarget,timeToTarget=spacetime.now().add(minsToTarget,"minutes").format("{hour-pad}:{minute-pad}{ampm}"),hoursToTarget=0|minsToTarget/60,minsToTarget-=60*hoursToTarget,apToMax=a-c,minsToMax=5*apToMax,timeToMax=spacetime.now().add(minsToMax,"minutes").format("{hour-pad}:{minute-pad}{ampm}"),hoursToMax=0|minsToMax/60,minsToMax-=60*hoursToMax,$("#ap-calc-target-mins").html((0<hoursToTarget?hoursToTarget+"h":"").concat(minsToTarget,"m")),$("#ap-calc-target-time").html(timeToTarget),$("#ap-calc-max-mins").html((0<hoursToMax?hoursToMax+"h":"").concat(minsToMax,"m")),$("#ap-calc-max-time").html(timeToMax),settings.maxAp=a,settings.targetAp=b,settings.currAp=c}const ftTimeTableEvents={NA:[{time:0,desc:"Event Start Time",server:"na"},{time:16,desc:"Daily Quest Rotation and FP Gacha Reset",server:"na"},{time:20,desc:"Daily Login Reset and Event End Time",server:"na"}],NA_DST:[{time:1,desc:"Event Start Time",server:"na"},{time:17,desc:"Daily Quest and FP Gacha Reset",server:"na"},{time:21,desc:"Daily Login Reset and Event End/Maintenance Start Time",server:"na"}],JP:[{time:0,desc:"Daily Quest Rotation and FP Gacha Reset",server:"jp"},{time:4,desc:"Daily Login Reset",server:"jp"},{time:13,desc:"Maintenance Start Time",server:"jp"}]};

let naServerDST=spacetime.now("Pacific Time").isDST(),etInterval=new interval(etTimersUpdate,"1s"),ftClockInterval=new interval(ftClockUpdate,"1s"),settings=localStorage.getItem("fgo-time-settings"),clockFormat="{hour-pad}:{minute-pad}{ampm}",jpToUTC=0,naToUTC=0,localToUTC=0;$(init),$(window).on("unload",()=>localStorage.setItem("fgo-time-settings",JSON.stringify(settings)));function init(){settings=null==settings?{showNa:!0,showJp:!0,showEventTimers:!0,showTimeTable:!0,showApCalc:!0,showLinks:!0}:JSON.parse(settings),!1===settings.showEventTimers&&($("#events").addClass("section-hidden"),$("#events > .content").hide()),!1===settings.showTimeTable&&($("#time-table").addClass("section-hidden"),$("#time-table > .content").hide()),!1===settings.showApCalc&&($("#ap-calc").addClass("section-hidden"),$("#ap-calc > .content").hide()),!1===settings.showLinks&&($("#links").addClass("section-hidden"),$("#links > .content").hide()),!1===settings.showNa&&$("#show-na").prop("checked",!1),!1===settings.showJp&&$("#show-jp").prop("checked",!1),settings.maxAp&&$("#ap-calc-max-ap").val(settings.maxAp),settings.targetAp&&$("#ap-calc-target-ap").val(settings.targetAp),settings.currAp&&$("#ap-calc-current-ap").val(settings.currAp),etTableSetup()&&!1!==settings.showEventTimers&&(etTimersUpdate(),etInterval.start()),ftClockUpdate(),ttSetup(),ftApCalcUpdate(),ftClockInterval.start(),$("main section > h1").on("click",sectionToggleDisplay),$("#ap-calc input").on("input",ftApCalcUpdate),$("main").show(),$("#loading").hide()}function sectionToggleDisplay(){for(section=$(this).parent();section&&!section.is("section");)section=section.parent();section.hasClass("section-hidden")?(section.removeClass("section-hidden"),section.find(".content").slideDown(200),settings["show"+section.data("name")]=!0,"events"==section.attr("id")&&(etTimersUpdate(),etInterval.start())):(section.addClass("section-hidden"),section.find(".content").slideUp(200),settings["show"+section.data("name")]=!1,"events"==section.attr("id")&&etInterval.stop())}function etTableSetup(){if(null!==eventTimer.NA.banner){let a=$("<img>").attr("src","assets/img/"+eventTimer.NA.banner);$("#event-banner-na").append(a)}if(null!==eventTimer.JP.banner){let a=$("<img>").attr("src","assets/img/"+eventTimer.JP.banner);$("#event-banner-jp").append(a)}if(1>eventTimer.NA.timer.length&&1>eventTimer.JP.timer.length)return!1;let a=Math.max(eventTimer.NA.timer.length,eventTimer.JP.timer.length);for(let b=0;b<a;b++){let a=$("<tr>"),c=$("<td>"),d=$("<td>");eventTimer.NA.timer[b]&&(c.append($("<span>").html(eventTimer.NA.timer[b].text+": ")),c.append($("<span>").addClass("timer").addClass("timer-na"))),eventTimer.JP.timer[b]&&(d.append($("<span>").html(eventTimer.JP.timer[b].text+": ")),d.append($("<span>").addClass("timer").addClass("timer-jp"))),a.append(c).append(d),$("#events table tbody").append(a)}return!0}function etTimersUpdate(){for(let a in eventTimer.NA.timer)$("#events table tbody").children().eq(a).find(".timer-na").html(etCalcTimer(eventTimer.NA.timer[a].time));for(let a in eventTimer.JP.timer)$("#events table tbody").children().eq(a).find(".timer-jp").html(etCalcTimer(eventTimer.JP.timer[a].time))}function etCalcTimer(a){let b=a-(0|Date.now()/1e3);if(0>=b)return"00:00:00:00";else{let a=b,c=0|a/86400;a%=86400;let d=0|a/3600;a%=3600;let e=0|a/60;a%=60;let f=(10>c?"0":"")+(c+"")+":"+(10>d?"0":"")+(d+"")+":"+(10>e?"0":"")+(e+"")+":"+(10>a?"0":"")+(a+"");return f}}function ttSetup(){$("input[type='checkbox']").on("change",ttToggleDisplay);let a=[].concat(tt);for(let b in a){let c,d,e,f,g,h=60*a[b].time+("na"==a[b].server?naToUTC:jpToUTC),i=60*a[b].time+localToUTC;0>h&&(h+=1440),1439<h&&(h-=1440),c=0|h/60,d=0|h%60,e=(10>c?"0":"")+(c+"")+":"+(10>d?"0":"")+(d+""),0>i&&(i+=1440),1439<i&&(i-=1440),c=0|i/60,d=0|i%60,f=(10>c?"0":"")+(c+"")+":"+(10>d?"0":"")+(d+""),g=100*c+d,a[b].serverTime=e,a[b].localTime=f,a[b].sortTime=+(c+d)}a.sort(function(c,a){return c.sortTime-a.sortTime}),console.log(a);for(let b of a){let a=$("<tr/>").attr("data-server",b.server);a.append($("<td/>").html(b.localTime)),a.append($("<td/>").html(b.serverTime.concat(" ","na"==b.server?naServerDST?"PDT":"PST":"JST"))),a.append($("<td/>").html(b.server.toUpperCase())),a.append($("<td/>").html(b.desc)),$("#time-table table tbody").append(a)}ttUpdateFilter()}function ttToggleDisplay(){switch(this.id){case"show-na":settings.showNa=this.checked;break;case"show-jp":settings.showJp=this.checked;break;default:return!1;}ttUpdateFilter()}function ttUpdateFilter(){let a=$("#time-table table tbody").children();for(let b of a){let a=$(b).data("server");if("na"===a){settings.showNa?$(b).show():$(b).hide();continue}"jp"===a&&(settings.showJp?$(b).show():$(b).hide())}}function ftClockUpdate(){let a=spacetime.now(),b=new Date().getTimezoneOffset(),c=a.format(clockFormat).toUpperCase(),d=a.clone().add(b,"minutes"),e=spacetime.now("Pacific Time").timezone().current.offset,f=d.clone().add(e,"hours"),g=f.format(clockFormat).toUpperCase(),h=spacetime.now("Asia/Tokyo").timezone().current.offset,i=d.clone().add(h,"hours"),j=i.format(clockFormat).toUpperCase();jpToUTC=60*h,naToUTC=60*e,localToUTC=-1*b,$("#clock-local > h2").html(c),$("#clock-na > h2").html(g),$("#clock-jp > h2").html(j)}function ftApCalcUpdate(){let a=+$("#ap-calc-max-ap").val(),b=+$("#ap-calc-target-ap").val(),c=+$("#ap-calc-current-ap").val();142<a&&(a=142,$("#ap-calc-max-ap").val(142)),0==a&&(a=1,$("#ap-calc-max-ap").val(1)),b>a&&(b=a,$("#ap-calc-target-ap").val(b)),$("#ap-calc-target-ap").attr("max",a),c>=b&&(c=b-1,$("#ap-calc-current-ap").val(c)),$("#ap-calc-current-ap").attr("max",b-1),apToTarget=b-c,minsToTarget=5*apToTarget,timeToTarget=spacetime.now().add(minsToTarget,"minutes").format("{hour-pad}:{minute-pad}{ampm}"),hoursToTarget=0|minsToTarget/60,minsToTarget-=60*hoursToTarget,apToMax=a-c,minsToMax=5*apToMax,timeToMax=spacetime.now().add(minsToMax,"minutes").format("{hour-pad}:{minute-pad}{ampm}"),hoursToMax=0|minsToMax/60,minsToMax-=60*hoursToMax,$("#ap-calc-target-mins").html((0<hoursToTarget?hoursToTarget+"h":"").concat(minsToTarget,"m")),$("#ap-calc-target-time").html(timeToTarget),$("#ap-calc-max-mins").html((0<hoursToMax?hoursToMax+"h":"").concat(minsToMax,"m")),$("#ap-calc-max-time").html(timeToMax),settings.maxAp=a,settings.targetAp=b,settings.currAp=c}

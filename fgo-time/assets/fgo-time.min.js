let eventTimer,naServerDST=spacetime.now("Pacific Time").isDST(),etInterval=new interval(etTimersUpdate,"1s"),ftClockInterval=new interval(ftClockUpdate,"1s"),settings=localStorage.getItem("fgo-time-settings"),clockFormat="{hour-pad}:{minute-pad}{ampm}",naToUTC=0,localToUTC=0;$(init),$(window).on("unload",()=>localStorage.setItem("fgo-time-settings",JSON.stringify(settings)));function init(){settings=null==settings?{showEventTimers:!0,showTimeTable:!0,showApCalc:!0,showLinks:!0,timerFormat:"colon"}:JSON.parse(settings),!1===settings.showEventTimers&&($("#events").addClass("section-hidden"),$("#events > .content").hide()),"colon"==settings.timerFormat&&$("#events").addClass("timers-monospace"),!1===settings.showTimeTable&&($("#time-table").addClass("section-hidden"),$("#time-table > .content").hide()),!1===settings.showApCalc&&($("#ap-calc").addClass("section-hidden"),$("#ap-calc > .content").hide()),!1===settings.showLinks&&($("#links").addClass("section-hidden"),$("#links > .content").hide()),settings.maxAp&&$("#ap-calc-max-ap").val(settings.maxAp),settings.targetAp&&$("#ap-calc-target-ap").val(settings.targetAp),settings.currAp&&$("#ap-calc-current-ap").val(settings.currAp),ftDataUpdate(),!1!==settings.showEventTimers&&etInterval.start(),ftClockUpdate(),ftClockInterval.start(),ftApCalcUpdate(),$("main section > h1").on("click",sectionToggleDisplay),$("#ap-calc input").on("input",ftApCalcUpdate),$("#nav-button-settings").on("click",openSettingsMenu),$("main").show(),$("#loading").hide()}function sectionToggleDisplay(){for(section=$(this).parent();section&&!section.is("section");)section=section.parent();section.hasClass("section-hidden")?("events"==section.attr("id")&&(ftDataUpdate(),etInterval.start()),section.removeClass("section-hidden"),section.find(".content").slideDown(200),settings["show"+section.data("name")]=!0):(section.addClass("section-hidden"),section.find(".content").slideUp(200),settings["show"+section.data("name")]=!1,"events"==section.attr("id")&&etInterval.stop())}function ftDataUpdate(){let a=new XMLHttpRequest;a.open("GET","assets/events.php",!0),a.onload=function(){ftHandleDataUpdate(a.responseText)},a.send()}function ftHandleDataUpdate(a){if(!a)throw new Error("Error while retrieving Event Data");a=JSON.parse(a),eventTimer=a,etTableSetup(),etTimersUpdate(),ttSetup()}function etTableSetup(){if(null!==eventTimer.banner){let a,b="assets/img/"+eventTimer.banner;0==$("#event-banner img").length?(a=$("<img>"),$("#event-banner").append(a)):a=$("#event-banner img"),a.attr("src")!=b&&a.attr("src",b)}else $("#event-banner").empty();if(null===eventTimer.notice?$("#event-notice").empty():$("#event-notice").html(eventTimer.notice),1>eventTimer.timers.length)return!1;$("#events table tbody").empty();for(let a of eventTimer.timers){let b=$("<tr>"),c=$("<td>");c.append($("<span>").html(a.text+": ")),c.append($("<span>").addClass("timer")),b.append(c),$("#events table tbody").append(b)}}function etTimersUpdate(){for(let a in eventTimer.timers)$("#events table tbody").children().eq(a).find(".timer").html(etCalcTimer(eventTimer.timers[a].time))}function etCalcTimer(a){let b=a-(0|Date.now()/1e3);if(0>=b)return"colon"==settings.timerFormat?"00:00:00:00":"0d 0h 0m 0s";else{let a=b,c=0|a/86400;a%=86400;let d=0|a/3600;a%=3600;let e=0|a/60;a%=60;let f;return f="colon"==settings.timerFormat?(10>c?"0":"")+(c+":")+(10>d?"0":"")+(d+":")+(10>e?"0":"")+(e+":")+(10>a?"0":"")+(a+""):c+"d "+(d+"h ")+(e+"m ")+(a+"s"),f}}function ttSetup(){let a=[].concat(eventTimer.timeTable);for(let b in a){let c,d,e,f,g,h=60*a[b].time+naToUTC,i=60*a[b].time+localToUTC;0>h&&(h+=1440),1439<h&&(h-=1440),c=0|h/60,d=0|h%60,e=(10>c?"0":"")+(c+"")+":"+(10>d?"0":"")+(d+""),0>i&&(i+=1440),1439<i&&(i-=1440),c=0|i/60,d=0|i%60,f=(10>c?"0":"")+(c+"")+":"+(10>d?"0":"")+(d+""),g=100*c+d,a[b].serverTime=e,a[b].localTime=f,a[b].sortTime=+(c+d)}a.sort(function(c,a){return c.sortTime-a.sortTime}),$("#time-table table tbody").empty();for(let b of a){let a=$("<tr/>");a.append($("<td/>").html(b.localTime)),a.append($("<td/>").html(b.serverTime.concat(" ",naServerDST?"PDT":"PST"))),a.append($("<td/>").html(b.desc)),$("#time-table table tbody").append(a)}}function ftClockUpdate(){let a=spacetime.now(),b=new Date().getTimezoneOffset(),c=a.format(clockFormat).toUpperCase(),d=a.clone().add(b,"minutes"),e=spacetime.now("Pacific Time").timezone().current.offset,f=d.clone().add(e,"hours"),g=f.format(clockFormat).toUpperCase();localToUTC=-1*b,$("#clock-local > h2").html(c),$("#clock-na > h2").html(g)}function ftApCalcUpdate(){let a=+$("#ap-calc-max-ap").val(),b=+$("#ap-calc-target-ap").val(),c=+$("#ap-calc-current-ap").val();142<a&&(a=142,$("#ap-calc-max-ap").val(142)),0==a&&(a=1,$("#ap-calc-max-ap").val(1)),b>a&&(b=a,$("#ap-calc-target-ap").val(b)),$("#ap-calc-target-ap").attr("max",a),c>=b&&(c=b-1,$("#ap-calc-current-ap").val(c)),$("#ap-calc-current-ap").attr("max",b-1),apToTarget=b-c,minsToTarget=5*apToTarget,timeToTarget=spacetime.now().add(minsToTarget,"minutes").format("{hour-pad}:{minute-pad}{ampm}"),hoursToTarget=0|minsToTarget/60,minsToTarget-=60*hoursToTarget,apToMax=a-c,minsToMax=5*apToMax,timeToMax=spacetime.now().add(minsToMax,"minutes").format("{hour-pad}:{minute-pad}{ampm}"),hoursToMax=0|minsToMax/60,minsToMax-=60*hoursToMax,$("#ap-calc-target-mins").html((0<hoursToTarget?hoursToTarget+"h":"").concat(minsToTarget,"m")),$("#ap-calc-target-time").html(timeToTarget),$("#ap-calc-max-mins").html((0<hoursToMax?hoursToMax+"h":"").concat(minsToMax,"m")),$("#ap-calc-max-time").html(timeToMax),settings.maxAp=a,settings.targetAp=b,settings.currAp=c}function makeModalBox(){let a=$("<div/>").addClass("modal-box"),b=$("<button>").addClass("button-cancel").on("click",destroyModal);return a.append(b),a}function openModal(a){let b=$("#modals");b.append(a),b.show(),$("body").css("overflow","hidden")}function destroyModal(){let a=$("#modals");a.find(".modal-box").remove(),a.hide(),$("body").css("overflow","visible")}function openSettingsMenu(){let a=makeModalBox();a.append($("<h1/>").html("Settings")),a.append($("<h2>").html("Event Timers")),a.append($("<div/>").css({margin:"0.5em 0"}).html("Timer Formats:"));let b=$("<div/>").addClass("radio-wrapper");b.append($("<input/>").attr({type:"radio",name:"settings-event-timer-format",id:"event-timer-format-colons"})).append($("<label/>").html("Colons").attr({for:"event-timer-format-colons"}).on("click",function(){settings.timerFormat="colon",$("#events").addClass("timers-monospace"),etTimersUpdate()})),b.append($("<input/>").attr({type:"radio",name:"settings-event-timer-format",id:"event-timer-format-units"})).append($("<label/>").html("Units").attr({for:"event-timer-format-units"}).on("click",function(){settings.timerFormat="unit",$("#events").removeClass("timers-monospace"),etTimersUpdate()})),"colon"==settings.timerFormat?b.find("#event-timer-format-colons").prop("checked",!0):b.find("#event-timer-format-units").prop("checked",!0),a.append(b),openModal(a)}
